<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="./styles/style.css">
        <title>Muldoon</title>
    </head>
    <body>
        <div id="titleBar">
            <img src="../HtmlPage/logo1.png" id="logo">
            <h1>Muldoon</h1>
        </div>
        <div id="navBar">
            <a>Home</a>
            <a>Graphs</a>
            <a>MEDA</a>
            <a>Astrojack</a>
        </div>
        <div id="content">
            <div id="graphInput">
                <label for="sol">Sol:</label>
                <input type="number" id="sol" name="sol" min="1" max="1000">
                <br>
                <label for="startTime">Graph Start Time:</label>
                <input type="number" id="startTime" name="startTime" min="0" max="1000" value="0">
                <br>
                <label for="endTime">Graph End Time:</label>
                <input type="number" id="endTime" name="endTime" min="0" max="1000" value="1000">
                <br>
                <label for="showSpeed">View Wind Speed:</label>
                <input type="checkbox" id="showSpeed" name="showSpeed">
                <br>
                <label for="showPressure">View Air Pressure:</label>
                <input type="checkbox" id="showPressure" name="showPressure">
                <br>
                <button>Plot Graph</button>
                <br>
                <p>
                    To generate a graph, first select a sol number to view.
                    Optionally, adjust the graph start and end times to view range subset of the data from the selected sol.
                    Check if the graph should display the wind speed and/or air pressure and finally click the 'Plot Graph' button to generate the graph.
                </p>
                <p>
                    After generating the graph it can be interacted with by (TODO: add interaction instructions after implementation)
                </p>
                <p>
                    The currently viewed graph may also be exported and shared either as an image, or as a url which will link back to the same graph with the same settings.
                    To do so, click the 'Export Image' or 'Export URL' buttons respectively.
                </p>
            </div>
            <div id="graph">
                <h2>MEDA Data Sol #X</h2>
                
                <div>
                    
                  </div>
                             <button id= "click" onclick="drawChart()">Draw Chart</button>
                             
                  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                  <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.0/chartjs-plugin-zoom.min.js" integrity="sha512-B6F98QATBNaDHSE7uANGo5h0mU6fhKCUD+SPAY7KZDxE8QgZw9rewDtNiu3mbbutYDWOKT3SPYD8qDBpG2QnEg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
                  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js" integrity="sha512-SGWgwwRA8xZgEoKiex3UubkSkV1zSE1BS6O4pXcaxcNtUlQsOmOmhVnDwIvqGRfEmuz83tIGL13cXMZn6upPyg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
                  <script src="https://d3js.org/d3.v7.min.js"></script>.
            <canvas id="myChart"></canvas>
                    
                  <script>
                    let chart = null;
                    const bgColor = {
                        id: 'bgColor',
                        beforeDraw: (chart, args, options) => {
                            const {ctx} = chart;
                            ctx.save();
                            ctx.globalCompositeOperation = 'destination-over';
                            ctx.fillStyle = options.color;
                            ctx.fillRect(0, 0, chart.width, chart.height);
                            ctx.restore();
                        }
                    };
                    drawChart();
                    async function drawChart(){
                        //simple csv parse to pull the MEDA data
                    d3.csv('.././tests/WE__0001___________DER_PS__________________P02.csv').then(function(results){
                        console.log(results)
                        let pressure = [];
                        let sol = [];
                        
                        //this is just to grab a small sample size.
                        //Possible to be updated to change the starting value of i and the 
                        //upper limit to what the user selects for sol range.
                        for(i= 0; i<10; i++){
                           let bar = results[i].PRESSURE;
                           let time = results[i].LMST;
                          
                           pressure.push(bar);
                           sol.push(time);
                            
                        }
                        d3.csv('.././tests/WE__0190___________DER_WS__________________P02.csv').then(function(results){
                        
                        let windSpeed = [];
                        
                        //This repeats the earlier process of parsing the file
                        //and placing the values for a small sample size into an
                        //array.
                        for(i= 0; i<10; i++){
                           let speed = results[i].HORIZONTAL_WIND_SPEED;

                           windSpeed.push(speed);
   
                        }

                    const ctx = document.getElementById('myChart');
                    chart = new Chart(ctx, {
                      type: 'line',
                      data: {
                        labels: sol, //x axis
                        datasets: [{
                        //this is how the pressure is mapped on the graph
                          label: 'pressure',
                          data: pressure, //y axis
                          borderWidth: 1,
                        },
                        {
                        //this is how the wind speed is mapped on the graph
                          label: 'wind speed',
                          data: windSpeed, //y axis
                          borderWidth: 1,
                    }],
                      },
                      options: {
                        scales: {
                          y: {
                            beginAtZero: true,
                          },

                        },
                        //this is the place for the different plugins and effects
                        //that can be used in the graph
                        plugins: {
                            zoom: {
                                zoom: {
                                    drag: {
                                        enabled: true
                                    }
                                }
                            },
                            bgColor: {
                                color: 'white'
                            }
                        }
                      },
                      plugins: [bgColor]
                    });
                   Chart.register(zoomPlugin);
                   });
                    });
                };
                   
                /*
                Attempt to get the fetch to work.
                */
                // async function getData(){
                //     const url = 'https://pds-atmospheres.nmsu.edu/PDS/data/PDS4/Mars2020/mars2020_meda/data_derived_env/sol_0180_0299/sol_0190/WE__0190___________DER_WS__________________P02.CSV'
                //     //  

                //     let myObject = await fetch(url, {
                //         mode: 'no-cors'
                //     });
         
                // }


                async function exportImage(){
                    let element = document.createElement('a');
                    element.href = chart.toBase64Image();
                    element.download = 'graph_export.png';
                    element.click();
                }
                  </script>

                  
                <div id="export">
                    <button onclick="exportImage()">Export Image</button>
                    <button>Export URL</button>
                </div>
            </div>
        </div>
        <div id="footerBar">
            <div class="aligned">
                <img src="./images/sdp-logo-3.png" height="48px" />
                <span>Boise State University</span>
            </div>
        </div>
    </body>
</html>
